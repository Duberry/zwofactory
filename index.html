<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>zwofactory</title>
    <link rel="stylesheet" href="site.css" />
</head> 
<body>
<h1>zwofactory</h1>

<div class="grid">
    <div class="u-1-4">
        <label for="txtName">Name</label>
        <input type="text" id="txtName" autofocus />
    </div>
    <div class="u-1-4">
        <label for="txtAuthor">Author</label>
        <input type="text" id="txtAuthor" />
    </div>
    <div class="u-1-4">
        <label for="txtTags">Tags</label>
        <input type="text" id="txtTags" />
    </div>
    <div class="u-1-4">
        <label for="txtDescription">Description</label>
        <textarea id="txtDescription" rows="2"></textarea>
    </div>
</div>

<div id="divControls" class="grid controls">
    <div class="u-1-10">
        <button class="control z1" data-ftp="50" data-length="10" data-count="1">Z1
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1"><input name="segment" type="radio"><label><div style="padding-top:150px;"><div class="z1" style="width: 100px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z2" data-ftp="60" data-length="5" data-count="1">Z2
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1"><input name="segment" type="radio"><label><div style="padding-top:120px;"><div class="z2" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z3" data-ftp="70" data-length="5" data-count="1">Z3
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1"><input name="segment" type="radio"><label><div style="padding-top:90px;"><div class="z3" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z4" data-ftp="80" data-length="5" data-count="1">Z4
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1"><input name="segment" type="radio"><label><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z5" data-ftp="90" data-length="5" data-count="1">Z5
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1"><input name="segment" type="radio"><label><div style="padding-top:30px;"><div class="z5" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z6" data-ftp="100" data-length="1" data-count="1">Z6
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1"><input name="segment" type="radio"><label><div style="padding-top:0px;"><div class="z6" style="width: 10px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control wu" data-ftp="50" data-length="10" data-count="1">warm up
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1 txtDuration2 txtPower2"><input name="segment" type="radio"><label><div style="padding-top:150px;"><div class="wu" style="width: 100px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control cd" data-ftp="50" data-length="10" data-count="1">cool down
            <div style="display:none" class="segment" data-enable="txtDuration1 txtPower1 txtDuration2 txtPower2"><input name="segment" type="radio"><label><div style="padding-top:150px;"><div class="cd" style="width: 100px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control fr" data-ftp="70" data-length="20" data-count="1">free ride
            <div style="display:none" class="segment" data-enable="txtDuration1"><input name="segment" type="radio"><label><div style="padding-top:90px;"><div class="fr" style="width: 200px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control in">int
            <div style="display:none" class="segment" data-enable="txtRepeat txtDuration1 txtPower1 txtDuration2 txtPower2"><input name="segment" type="radio"><label><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div><div style="padding-top:120px;"><div class="z2" style="width: 20px;"></div></div><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div><div style="padding-top:120px;"><div class="z2" style="width: 20px;"></div></div><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div><div style="padding-top:120px;"><div class="z2" style="width: 20px;"></div></div></label></div>
        </button>
    </div>
</div>

<div class="grid">
    <div class="u-1-10"><button id="btnMoveLeft">Move left</button></div>
    <div class="u-1-10"><button id="btnMoveRight">Move right</button></div>
    <div class="u-1-10"><button id="btnDelete">Delete</button></div>
    <div class="u-1-10"><label for="txtRepeat">Repeat</label><input disabled type="number" id="txtRepeat" /></div>
    <div class="u-1-10"><label for="txtDuration1">Duration</label><input disabled type="number" id="txtDuration1" /></div>
    <div class="u-1-10"><label for="txtPower1">%FTP</label><input disabled type="number" id="txtPower1" /></div>
    <div class="u-1-10"><label for="txtDuration2">Duration 2</label><input disabled type="number" id="txtDuration2" /></div>
    <div class="u-1-10"><label for="txtPower2">%FTP 2</label><input disabled type="number" id="txtPower2" /></div>
</div>

<div id="divSegmentChart" class="u-4-5">
</div>


<script>
    document.getElementById('divControls').addEventListener('click', function(e) {
        if (e.target.tagName == 'BUTTON') addSegment(e.target);
    });


    document.getElementById('divSegmentChart').addEventListener('click', function(e) {
        if (e.target.tagName != 'INPUT') return;
        loadSegment(e.target.getAttribute('id'));
    });


    document.getElementById('btnMoveLeft').addEventListener('click', function(e) {
        var selectedBlock = getSelectedBlock();
        if (!selectedBlock) return;
        var previousBlock = selectedBlock.previousElementSibling;
        if (previousBlock) selectedBlock.parentNode.insertBefore(selectedBlock, previousBlock);
    });


    document.getElementById('btnMoveRight').addEventListener('click', function(e) {
        var selectedBlock = getSelectedBlock();
        if (!selectedBlock) return;
        var nextBlock = selectedBlock.nextElementSibling;
        if (nextBlock) selectedBlock.parentNode.insertBefore(nextBlock, selectedBlock);
    });


    document.getElementById('btnDelete').addEventListener('click', function(e) {
        var selectedBlock = getSelectedBlock();
        if (!selectedBlock) return;
        var previousBlock = selectedBlock.previousElementSibling;
        var nextBlock = selectedBlock.nextElementSibling;
        selectedBlock.parentNode.removeChild(selectedBlock);
        if (previousBlock && !nextBlock) {
            previousBlock.querySelector('input[type=radio]').checked = true;
            loadSegment(previousBlock.getAttribute('data-id'));
        }
        else if (nextBlock) {
            nextBlock.querySelector('input[type=radio]').checked = true;
            loadSegment(nextBlock.getAttribute('data-id'));
        }
    });


    document.getElementById('divSegmentChart').addEventListener('change', function(e) {
        loadSegment(e.target.id);
    });


    function addSegment(sourceElement) {
        var id = 'x' + createGuid();
        var clone = sourceElement.querySelector('div').cloneNode(true);
        clone.setAttribute('data-id', id);
        clone.removeAttribute('style');

        var input = clone.querySelector('input');
        input.setAttribute('id', id);
        input.checked = true;

        var label = clone.querySelector('label');
        label.setAttribute('for', id);

        document.getElementById('divSegmentChart').appendChild(clone);
        clone.scrollIntoView();
        loadSegment(id);
    }


    function getSelectedBlock() {
        var selectedSegment = document.querySelector('#divSegmentChart input:checked');
        if (!selectedSegment) return null;
        return document.querySelector('div[data-id="' + selectedSegment.id + '"]');
    }


    function loadSegment(segmentId) {
        var txtRepeat = document.querySelector('#txtRepeat');
        var txtDuration1 = document.querySelector('#txtDuration1');
        var txtPower1 = document.querySelector('#txtPower1');
        var txtDuration2 = document.querySelector('#txtDuration2');
        var txtPower2 = document.querySelector('#txtPower2');
        var selectedSegment = document.querySelector('div[data-id="' + segmentId + '"]');
        var inputsToEnable = selectedSegment.getAttribute('data-enable').split(' ');
        var repeat = selectedSegment.querySelectorAll('label > div').length / 2;
        var duration1 = selectedSegment.querySelector('label > div > div').offsetWidth;
        var power1 = selectedSegment.querySelector('label > div').style.paddingTop.replace('px', '');
        // TODO left off here
        
        if (inputsToEnable.indexOf('txtRepeat') != -1) { txtRepeat.value = repeat; txtRepeat.removeAttribute('disabled'); } else { txtRepeat.value = ''; txtRepeat.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtDuration1') != -1) txtDuration1.removeAttribute('disabled'); else { txtDuration1.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtPower1') != -1) txtPower1.removeAttribute('disabled'); else { txtPower1.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtDuration2') != -1) txtDuration2.removeAttribute('disabled'); else { txtDuration2.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtPower2') != -1) txtPower2.removeAttribute('disabled'); else { txtPower2.setAttribute('disabled', true); }
    }


    function createGuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        });
    }

    function findAncestorByClass (el, cls) {
        while ((el = el.parentElement) && !el.classList.contains(cls));
        return el;
    }
</script>

</body>
</html>
