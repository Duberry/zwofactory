<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>zwofactory</title>
    <link rel="stylesheet" href="site.css" />
</head> 
<body>
<h1>zwofactory</h1>

<div class="grid">
    <div class="u-1-4">
        <label for="txtName">Name</label>
        <input type="text" id="txtName" autofocus />
    </div>
    <div class="u-1-4">
        <label for="txtAuthor">Author</label>
        <input type="text" id="txtAuthor" />
    </div>
    <div class="u-1-4">
        <label for="txtTags">Tags</label>
        <input type="text" id="txtTags" />
    </div>
    <div class="u-1-4">
        <label for="txtDescription">Description</label>
        <textarea id="txtDescription" rows="2"></textarea>
    </div>
</div>

<div id="divControls" class="grid controls">
    <div class="u-1-10">
        <button class="control z1" data-ftp="50" data-length="10">Z1</button>
    </div>
    <div class="u-1-10">
        <button class="control z2" data-ftp="60" data-length="5">Z2</button>
    </div>
    <div class="u-1-10">
        <button class="control z3" data-ftp="70" data-length="5">Z3</button>
    </div>
    <div class="u-1-10">
        <button class="control z4" data-ftp="80" data-length="5">Z4</button>
    </div>
    <div class="u-1-10">
        <button class="control z5" data-ftp="90" data-length="5">Z5</button>
    </div>
    <div class="u-1-10">
        <button class="control z6" data-ftp="100" data-length="1">Z6</button>
    </div>
    <div class="u-1-10">
        <button class="control wu" data-ftp="50" data-length="10">warm up</button>
    </div>
    <div class="u-1-10">
        <button class="control cd" data-ftp="50" data-length="10">cool down</button>
    </div>
    <div class="u-1-10">
        <button class="control fr" data-ftp="70" data-length="20">free ride</button>
    </div>
    <div class="u-1-10">
        <button class="control te">text event</button>
    </div>
</div>

<div class="grid">
    <div class="u-1">
        <button id="btnMoveLeft">Move left</button>
        <button id="btnMoveRight">Move right</button>
        <button id="btnDelete">Delete</button>
    </div>
</div>

<div id="divSegmentChart" class="u-4-5">
</div>


<script>
    document.getElementById('divControls').addEventListener('click', function(e) {
        if (e.target.tagName == 'BUTTON') addSegment(e.target);
    });


    document.getElementById('divSegmentChart').addEventListener('click', function(e) {
        if (e.target.tagName != 'INPUT') return;
        loadSegment(e.target.getAttribute('id'));
    });


    document.getElementById('btnMoveLeft').addEventListener('click', function(e) {
        var selectedBlock = getSelectedBlock();
        if (!selectedBlock) return;
        var previousBlock = selectedBlock.previousElementSibling;
        if (previousBlock) selectedBlock.parentNode.insertBefore(selectedBlock, previousBlock);
    });


    document.getElementById('btnMoveRight').addEventListener('click', function(e) {
        var selectedBlock = getSelectedBlock();
        if (!selectedBlock) return;
        var nextBlock = selectedBlock.nextElementSibling;
        if (nextBlock) selectedBlock.parentNode.insertBefore(nextBlock, selectedBlock);
    });


    document.getElementById('btnDelete').addEventListener('click', function(e) {
        var selectedBlock = getSelectedBlock();
        if (!selectedBlock) return;
        var previousBlock = selectedBlock.previousElementSibling;
        var nextBlock = selectedBlock.nextElementSibling;
        selectedBlock.parentNode.removeChild(selectedBlock);
        if (previousBlock && !nextBlock) previousBlock.querySelector('input[type=radio]').checked = true;
        else if (nextBlock) nextBlock.querySelector('input[type=radio]').checked = true;
    });


    function addSegment(sourceElement) {
        var id = 'x' + createGuid();
        var input = document.createElement('input');
        input.setAttribute('type', 'radio');
        input.setAttribute('name','segment');
        input.setAttribute('id', id);
        input.checked = true;

        var divBlock = document.createElement('div');
        divBlock.classList.add('block');
        divBlock.setAttribute('data-id', id);

        var label = document.createElement('label');
        label.setAttribute('for', id);
        label.classList.add('block');
        
        var div1 = document.createElement('div');
        div1.setAttribute('style', 'padding-top:' + (300 - 3*parseInt(sourceElement.getAttribute('data-ftp'))) + 'px;');

        var div2 = document.createElement('div');
        div2.classList.add(sourceElement.classList[1]);
        div2.setAttribute('style', 'width: ' + 10 * parseInt(sourceElement.getAttribute('data-length')) + 'px;');

        div1.appendChild(div2);
        label.appendChild(div1);
        divBlock.appendChild(input);
        divBlock.appendChild(label);
        document.getElementById('divSegmentChart').appendChild(divBlock);
        loadSegment(id);
    }


    function getSelectedBlock() {
        var selectedSegment = document.querySelector('#divSegmentChart input:checked');
        if (!selectedSegment) return null;
        return document.querySelector('div[data-id="' + selectedSegment.id + '"]');
    }


    function loadSegment(segmentId) {
        console.log('loading ' + segmentId);
    }


    function createGuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        });
    }

    function findAncestorByClass (el, cls) {
        while ((el = el.parentElement) && !el.classList.contains(cls));
        return el;
    }
</script>

</body>
</html>
