<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>zwofactory</title>
    <link rel="stylesheet" href="site.css" />
</head> 
<body>
<h1>zwofactory</h1>

<div class="grid">
    <div class="u-1-4">
        <label for="txtName">Name</label>
        <input type="text" id="txtName" autofocus />
    </div>
    <div class="u-1-4">
        <label for="txtAuthor">Author</label>
        <input type="text" id="txtAuthor" />
    </div>
    <div class="u-1-4">
        <label for="txtTags">Tags</label>
        <input type="text" id="txtTags" />
    </div>
    <div class="u-1-4">
        <label for="txtDescription">Description</label>
        <textarea id="txtDescription" rows="2"></textarea>
    </div>
</div>

<div id="divControls" class="grid controls">
    <div class="u-1-10">
        <button class="control z1">Z1
            <div style="display:none" class="segment" data-segment-type="SteadyState" data-ftp="50" data-duration="300" data-enable="txtDuration1 txtFtp1"><input name="segment" type="radio"><label><div style="padding-top:250px;"><div class="z1" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z2">Z2
            <div style="display:none" class="segment" data-segment-type="SteadyState" data-ftp="65" data-duration="300" data-enable="txtDuration1 txtFtp1"><input name="segment" type="radio"><label><div style="padding-top:235px;"><div class="z2" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z3">Z3
            <div style="display:none" class="segment" data-segment-type="SteadyState" data-ftp="80" data-duration="300" data-enable="txtDuration1 txtFtp1"><input name="segment" type="radio"><label><div style="padding-top:220px;"><div class="z3" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z4">Z4
            <div style="display:none" class="segment" data-segment-type="SteadyState" data-ftp="95" data-duration="300" data-enable="txtDuration1 txtFtp1"><input name="segment" type="radio"><label><div style="padding-top:205px;"><div class="z4" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z5">Z5
            <div style="display:none" class="segment" data-segment-type="SteadyState" data-ftp="100" data-duration="300" data-enable="txtDuration1 txtFtp1"><input name="segment" type="radio"><label><div style="padding-top:200px;"><div class="z5" style="width: 50px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control z6">Z6
            <div style="display:none" class="segment" data-segment-type="SteadyState" data-ftp="125" data-duration="60" data-enable="txtDuration1 txtFtp1"><input name="segment" type="radio"><label><div style="padding-top:175px;"><div class="z6" style="width: 10px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control wu">warm up
            <div style="display:none" class="segment" data-segment-type="Warmup" data-ftp="25" data-duration="600" data-ftp-2="75" data-enable="txtDuration1 txtFtp1 txtFtp2"><input name="segment" type="radio"><label><div style="padding-top:150px;"><div class="wu" style="width: 100px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control cd">cool down
            <div style="display:none" class="segment" data-segment-type="Cooldown" data-ftp="75" data-duration="600" data-ftp-2="25" data-enable="txtDuration1 txtFtp1 txtFtp2"><input name="segment" type="radio"><label><div style="padding-top:150px;"><div class="cd" style="width: 100px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control fr">free ride
            <div style="display:none" class="segment" data-segment-type="FreeRide" data-ftp="70" data-duration="600" data-enable="txtDuration1"><input name="segment" type="radio"><label><div style="padding-top:90px;"><div class="fr" style="width: 200px;"></div></div></label></div>
        </button>
    </div>
    <div class="u-1-10">
        <button class="control in">int
            <div style="display:none" class="segment" data-segment-type="IntervalsT" data-ftp="75" data-duration="60" data-ftp-2="50" data-duration-2="300" data-repeat="4" data-enable="txtRepeat txtDuration1 txtFtp1 txtDuration2 txtFtp2"><input name="segment" type="radio"><label><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div><div style="padding-top:120px;"><div class="z2" style="width: 20px;"></div></div><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div><div style="padding-top:120px;"><div class="z2" style="width: 20px;"></div></div><div style="padding-top:60px;"><div class="z4" style="width: 50px;"></div></div><div style="padding-top:120px;"><div class="z2" style="width: 20px;"></div></div></label></div>
        </button>
    </div>
</div>

<div class="grid">
    <div class="u-1-10"><button id="btnMoveLeft">← Move Left</button></div>
    <div class="u-1-10"><button id="btnMoveRight">Move Right →</button></div>
    <div class="u-1-10"></div>
    <div class="u-1-10"></div>
    <div class="u-1-10"></div>
    <div class="u-1-10"></div>
    <div class="u-1-10"></div>
    <div class="u-1-10"></div>
    <div class="u-1-10"></div>
    <div class="u-1-10" style="text-align: right"><button id="btnDelete">⌫ Delete</button></div>
</div>

<div id="divSegmentChart" class="u-4-5">
</div>

<div id="divSegmentInputs" class="grid">
    <div class="u-1-5"><label for="txtFtp1">FTP (%)</label><input disabled type="number" id="txtFtp1" /></div>
    <div class="u-1-5"><label for="txtDuration1">Duration (s)</label><input disabled type="number" id="txtDuration1" /></div>
    <div class="u-1-5"><label for="txtFtp2">FTP 2 (%)</label><input disabled type="number" id="txtFtp2" /></div>
    <div class="u-1-5"><label for="txtDuration2">Duration 2 (s)</label><input disabled type="number" id="txtDuration2" /></div>
    <div class="u-1-5"><label for="txtRepeat">Repeat</label><input disabled type="number" id="txtRepeat" /></div>
</div>


<script>
    document.getElementById('divControls').addEventListener('click', function(e) {
        if (e.target.tagName == 'BUTTON') addSegment(e.target);
    });


    document.getElementById('divSegmentChart').addEventListener('click', function(e) {
        if (e.target.tagName != 'INPUT') return;
        loadSegment(e.target.getAttribute('id'));
    });


    document.getElementById('divSegmentInputs').addEventListener('input', function() {
        redrawSelectedSegment();
    });


    document.getElementById('btnMoveLeft').addEventListener('click', function(e) {
        var selectedSegment = getSelectedSegment();
        if (!selectedSegment) return;
        var previousBlock = selectedSegment.previousElementSibling;
        if (previousBlock) selectedSegment.parentNode.insertBefore(selectedSegment, previousBlock);
    });


    document.getElementById('btnMoveRight').addEventListener('click', function(e) {
        var selectedSegment = getSelectedSegment();
        if (!selectedSegment) return;
        var nextBlock = selectedSegment.nextElementSibling;
        if (nextBlock) selectedSegment.parentNode.insertBefore(nextBlock, selectedSegment);
    });


    document.getElementById('btnDelete').addEventListener('click', function(e) {
        var selectedSegment = getSelectedSegment();
        if (!selectedSegment) return;
        var previousBlock = selectedSegment.previousElementSibling;
        var nextBlock = selectedSegment.nextElementSibling;
        selectedSegment.parentNode.removeChild(selectedSegment);
        if (previousBlock && !nextBlock) {
            previousBlock.querySelector('input[type=radio]').checked = true;
            loadSegment(previousBlock.getAttribute('data-id'));
        }
        else if (nextBlock) {
            nextBlock.querySelector('input[type=radio]').checked = true;
            loadSegment(nextBlock.getAttribute('data-id'));
        } else {
            loadNoSegment();
        }
    });


    document.getElementById('divSegmentChart').addEventListener('change', function(e) {
        loadSegment(e.target.id);
    });


    function addSegment(sourceElement) {
        var id = 'x' + createGuid();
        var clone = sourceElement.querySelector('div').cloneNode(true);
        clone.setAttribute('data-id', id);
        clone.removeAttribute('style');

        var input = clone.querySelector('input');
        input.setAttribute('id', id);
        input.checked = true;

        var label = clone.querySelector('label');
        label.setAttribute('for', id);

        document.getElementById('divSegmentChart').appendChild(clone);
        clone.scrollIntoView();
        loadSegment(id);
    }


    function getSelectedSegment() {
        var selectedSegment = document.querySelector('#divSegmentChart input:checked');
        if (!selectedSegment) return null;
        return document.querySelector('div[data-id="' + selectedSegment.id + '"]');
    }


    function loadSegment(segmentId) {
        var txtRepeat = document.querySelector('#txtRepeat');
        var txtDuration1 = document.querySelector('#txtDuration1');
        var txtFtp1 = document.querySelector('#txtFtp1');
        var txtDuration2 = document.querySelector('#txtDuration2');
        var txtFtp2 = document.querySelector('#txtFtp2');
        var selectedSegment = document.querySelector('div[data-id="' + segmentId + '"]');
        var inputsToEnable = selectedSegment.getAttribute('data-enable').split(' ');
        var repeat = selectedSegment.getAttribute('data-repeat');
        var duration1 = selectedSegment.getAttribute('data-duration');
        var ftp1 = selectedSegment.getAttribute('data-ftp');
        var duration2 = selectedSegment.getAttribute('data-duration-2');
        var ftp2 = selectedSegment.getAttribute('data-ftp-2');
        // TODO left off here
        
        if (inputsToEnable.indexOf('txtRepeat') != -1) { txtRepeat.value = repeat; txtRepeat.removeAttribute('disabled'); } else { txtRepeat.value = ''; txtRepeat.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtDuration1') != -1) { txtDuration1.value = duration1; txtDuration1.removeAttribute('disabled'); } else { txtDuration1.value = ''; txtDuration1.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtFtp1') != -1) { txtFtp1.value = ftp1; txtFtp1.removeAttribute('disabled'); } else { txtFtp1.value = ''; txtFtp1.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtDuration2') != -1) { txtDuration2.value = duration2; txtDuration2.removeAttribute('disabled'); } else { txtDuration2.value = ''; txtDuration2.setAttribute('disabled', true); }
        if (inputsToEnable.indexOf('txtFtp2') != -1) { txtFtp2.value = ftp2; txtFtp2.removeAttribute('disabled'); } else { txtFtp2.value = ''; txtFtp2.setAttribute('disabled', true); }
    }


    function loadNoSegment() {
        var txtRepeat = document.querySelector('#txtRepeat');
        txtRepeat.value = ''; 
        txtRepeat.setAttribute('disabled', true);
        var txtDuration1 = document.querySelector('#txtDuration1');
        txtDuration1.value = ''; 
        txtDuration1.setAttribute('disabled', true);
        var txtFtp1 = document.querySelector('#txtFtp1');
        txtFtp1.value = ''; 
        txtFtp1.setAttribute('disabled', true);
        var txtDuration2 = document.querySelector('#txtDuration2');
        txtDuration2.value = ''; 
        txtDuration2.setAttribute('disabled', true);
        var txtFtp2 = document.querySelector('#txtFtp2');
        txtFtp2.value = ''; 
        txtFtp2.setAttribute('disabled', true);
    }


    function redrawSelectedSegment() {
        var selectedSegment = getSelectedSegment();

        switch (selectedSegment.getAttribute('data-segment-type')) {
            case "SteadyState":
                redrawSegmentSteadyState(selectedSegment);
                break;
            case "Warmup":
            case "Cooldown":
                redrawSegmentRamp(selectedSegment);
                break;
            case "FreeRide":
                redrawSegmentFreeRide(selectedSegment);
                break;
            case "IntervalsT":
                redrawSegmentIntervalsT(selectedSegment);
                break;
            default:
                break;
        }
    }


    function redrawSegmentSteadyState(segment) {
        var ftp1 = getNumericInput('txtFtp1', 5);
        var duration1 = getNumericInput('txtDuration1', 1); 

        segment.setAttribute('data-ftp', ftp1);
        segment.setAttribute('data-duration', duration1);

        var divToRedrawWidth = segment.querySelector('label > div > div');
        var newWidth = Math.max(Math.floor(duration1 / 6), 10);
        divToRedrawWidth.setAttribute('style', 'width: ' + newWidth + 'px;');

        var divToRepad = segment.querySelector('label > div');
        var newPadding = Math.max(Math.floor(300 - Math.min(ftp1, 300)), 0);
        divToRepad.setAttribute('style', 'padding-top: ' + newPadding + 'px');
    }


    function redrawSegmentRamp(segment) {
        var ftp1 = document.getElementById('txtFtp1').value;
        var duration1 = document.getElementById('txtDuration1').value;
        var ftp2 = document.getElementById('txtFtp2').value;
        var duration2 = document.getElementById('txtDuration2').value;

        segment.setAttribute('data-ftp', ftp1);
        segment.setAttribute('data-duration', duration1);
        segment.setAttribute('data-ftp-2', ftp2);
        segment.setAttribute('data-duration-2', duration2);
    }


    function redrawSegmentFreeRide(segment) {
        var duration1 = document.getElementById('txtDuration1').value;

        segment.setAttribute('data-duration', duration1);
    }


    function redrawSegmentIntervalsT(segment) {
        var ftp1 = document.getElementById('txtFtp1').value;
        var duration1 = document.getElementById('txtDuration1').value;
        var ftp2 = document.getElementById('txtFtp2').value;
        var duration2 = document.getElementById('txtDuration2').value;
        var repeat = document.getElementById('txtRepeat').value;

        segment.setAttribute('data-ftp', ftp1);
        segment.setAttribute('data-duration', duration1);
        segment.setAttribute('data-ftp-2', ftp2);
        segment.setAttribute('data-duration-2', duration2);
        segment.setAttribute('data-repeat', repeat);
    }


    function createGuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        });
    }


    function getNumericInput(elementId, minimumDefaultValue) {
        var strVal = document.getElementById(elementId).value;
        var intVal = parseInt(strVal);
        if (!intVal) return minimumDefaultValue;

        return Math.max(intVal, minimumDefaultValue);
    }
</script>

</body>
</html>
